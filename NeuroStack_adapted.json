{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Neurostack, adapted because the IAM settings were restricted in the NDA account",
  "Parameters": {
    "BucketPrefix": {
      "Type": "String",
      "Default": "neurostack-input-"
    }
  },
  "Resources": {
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway"
    },
    "RouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": "vpc-d0d7bbad"
      }
    },
    "VPCGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": "vpc-d0d7bbad",
        "InternetGatewayId": {
          "Ref": "InternetGateway"
        }
      }
    },
    "Route": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway"
        }
      }
    },
    "SubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteTable"
        },
        "SubnetId": "subnet-ac2d38a2"
      }
    },
    "IamInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Roles": [
          "arn:aws:iam::168045869720:role/IAMconfig-EcsInstanceRole-7NJ0HGS3KDCC"
        ]
      }
    },
    "LaunchTemplate": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateName": "neurostack-launch-template",
        "LaunchTemplateData": {
          "BlockDeviceMappings": [
            {
              "Ebs": {
                "VolumeSize": "50",
                "VolumeType": "gp2",
                "DeleteOnTermination": true,
                "Encrypted": true
              },
              "DeviceName": "/dev/xvdcz"
            }
          ],
          "CreditSpecification": {
            "CpuCredits": "unlimited"
          },
          "Monitoring": {
            "Enabled": true
          }
        }
      }
    },
    "ComputeEnvironment": {
      "Type": "AWS::Batch::ComputeEnvironment",
      "Properties": {
        "ComputeEnvironmentName": "neurostack-spot-computeenvironment",
        "Type": "MANAGED",
        "ComputeResources": {
          "Type": "SPOT",
          "AllocationStrategy": "SPOT_CAPACITY_OPTIMIZED",
          "MinvCpus": 0,
          "DesiredvCpus": 0,
          "MaxvCpus": 256,
          "InstanceTypes": [
            "optimal"
          ],
          "Subnets": [
            "subnet-ac2d38a2"
          ],
          "SecurityGroupIds": [
            "sg-08107bd858498e8ef"
          ],
          "InstanceRole": {
            "Ref": "IamInstanceProfile"
          }
        },
        "ServiceRole": "arn:aws:iam::168045869720:role/IAMconfig-BatchServiceRole-VNCD07BH1AQF"
      }
    },
    "JobQueue": {
      "Type": "AWS::Batch::JobQueue",
      "Properties": {
        "JobQueueName": "neurostack-jobqueue",
        "Priority": 1,
        "ComputeEnvironmentOrder": [
          {
            "Order": 1,
            "ComputeEnvironment": {
              "Ref": "ComputeEnvironment"
            }
          }
        ]
      }
    },
    "JobDefinition": {
      "Type": "AWS::Batch::JobDefinition",
      "Properties": {
        "JobDefinitionName": "neurostack-jobdefinition",
        "Type": "container",
        "ContainerProperties": {
          "Image": "public.ecr.aws/v8l0a1m9/maget_neurostack",
          "JobRoleArn": "arn:aws:iam::168045869720:role/IAMconfig-Ec2S3FullAccessRole-1RRQ57X5ZHDPV",
          "Vcpus": 4,
          "Memory": 10000,
          "Command": [
            "neurostack_script.sh"
          ],
          "Volumes": [
            {
              "Host": {
                "SourcePath": "/maget"
              },
              "Name": "ebs"
            }
          ],
          "MountPoints": [
            {
              "ContainerPath": "/maget",
              "ReadOnly": false,
              "SourceVolume": "ebs"
            }
          ],
          "Environment": [
            {
              "Name": "BATCH_FILE_S3_URL",
              "Value": {
                "Fn::Sub": "s3://neurostack-script-${AWS::AccountId}/neurostack_script.sh"
              }
            },
            {
              "Name": "BATCH_FILE_TYPE",
              "Value": "script"
            }
          ]
        },
        "RetryStrategy": {
          "Attempts": 1
        }
      }
    }
  }
}